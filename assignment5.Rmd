---
title: "assignment5"
author: "Rachel Green"
date: "November 27, 2018"
output: html_document
---

Setup Code:
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(car)
library(userfriendlyscience)
library(knitr)
library(kableExtra)
library(effsize)
library(ggrepel)
fs = read_csv("faculty_salary_data_2008_2009_survey.csv")
ge = read_csv("grad_enrollment.csv")
ms = read_csv("median_salary_doctoral_recipients.csv")
pf = read_csv("phds_by_field_1985_2015.csv")
```

Problem 1 (Jeremy):
```{r}
total_males <- ge %>% 
  select(year, total_males) %>% 
  mutate(total = total_males) %>% # 
  mutate(sex = rep("male", length(total_males))) %>% 
  select(year, total, sex)
total_females <- ge %>% 
  select(year, total_females) %>% 
  mutate(total = total_females) %>% 
  mutate(sex = rep("female", length(total_females))) %>% 
  select(year, total, sex)
total <- rbind(total_males, total_females)

total_enroll_plot <- ggplot(total, aes(x = year, y = total, shape = sex, color = sex)) +
  geom_point(size = 2, alpha = 0.5) +
  geom_smooth(method = "lm") +
  theme_classic() +
  theme(panel.border = element_rect(colour = "black", fill = NA, size = 0.7)) +
  labs(x = "Year", y = "Total Male & Female Graduate Student \nEnrollment in the U.S.") +
  scale_y_continuous() +
  scale_color_manual(values = c("grey11", "gray48")) +
  annotate("text", 
           x = 2010, 
           y = 940000, 
           label = "y = 9.42e-05x + 1.9e03", 
           family = "Times New Roman", 
           size = 3) +
  annotate("text", 
           x = 2010, 
           y = 880000, 
           label = "italic(R)^2 == 0.85", 
           parse = TRUE, 
           family = "Times New Roman", 
           size = 3) +
  annotate("text", 
           x = 1999, 
           y = 1600000, 
           label = "y = 3.26e-05x + 1.96e03", 
           family = "Times New Roman", 
           size = 3) +
  annotate("text", 
           x = 1999, 
           y = 1550000, 
           label = "italic(R)^2 == 0.98", 
           parse = TRUE, 
           family = "Times New Roman", 
           size = 3) 
total_enroll_plot
# Figure 1. Relationship between year and graduate student enrollment for both males and females (1967-2015). Year significantly predicts graduate student enrollment in the U.S. for both males (*b* = 9.42e-05, t(47) = 16.61, *p* <0.001) and females (*b* = 3.26e-05, t(47) = 51.66, *p* < 0.001) with a strong positive correlation between year and both sexes (Pearson's *r* (males) = 0.92, Pearson's *r* (females) =  0.99). The overall models (male enrollment = 9.42e-05(year) + 1.9e03, female enrollment = 3.26e-05(year) + 1.96e03) explain a significant amount of variance in salary for males (F(1,47) = 276, *p* < 0.001), R^2^ = 0.85 and females (F(1.9,47) = 2669, *p* < 0.001, R^2^ = 0.98). Gray region is the 95% confidence interval for the mean predicted values.

# lm for males
enrollment_males_lm <- lm(year ~ total, data = total_males)
summary(enrollment_males_lm)
cor.test(total_males$total, total_males$year) 
# lm for females
enrollment_females_lm <- lm(year ~ total, data = total_females)
summary(enrollment_females_lm)
cor.test(total_females$total, total_females$year) 


m_1967 <- total_males %>% # subset 1967 males
  filter(year == 1967)
m_2015 <- total_males %>% # subset 2015 males
  filter(year == 2015)
net_males <- m_2015$total - m_1967$total # net increase from 1967-2015
fold_males <- m_2015$total/m_1967$total # fold increase from 1967-2015
perc_males <- ((m_2015$total - m_1967$total)/m_1967$total) * 100 # % increase from 1967 - 2015


f_1967 <- total_females %>% # subset 1967 females
  filter(year == 1967)
f_2015 <- total_females %>% # subset 2015 females 
  filter(year == 2015)
net_females <- f_2015$total - f_1967$total # net increase from 1967-2015
fold_females <- f_2015$total/f_1967$total # fold increase from 1967-2015
perc_females <- ((f_2015$total - f_1967$total)/f_1967$total) * 100 # % increase from 1967 - 2015


# since 1967, there has been a dramatic rise in female graduate student enrollment in the U.S. as compared to males
# male enrollment has nearly doubled (1.9 fold), whereas female enrollment has seen a 6.5 fold increase
# net increase in males was 59,0865; net increase in females was 1,453,562

```
Problem 1 (Michael):
```{r}
ge_adddecyear <- ge %>%
  mutate(year1 = year - min(year))

lm_gem1 <- lm(total_males ~ year1, data = ge_adddecyear)
summary(lm_gem1)

lm_gef1 <- lm(total_females ~ year1, data = ge_adddecyear)
summary(lm_gef1)

# predict from model over the same time domain
ge_year <- data.frame(year1 = c(0:48))
ge_year$year <- c(1967:2015)
predict_m <- as.data.frame(predict(lm_gem1, newdata = ge_year, se.fit = TRUE, interval="confidence"))
predict_f <- as.data.frame(predict(lm_gef1, newdata = ge_year, se.fit = TRUE, interval="confidence"))
names(predict_m) <- paste(names(predict_m), "m", sep = "_")
names(predict_f) <- paste(names(predict_f), "f", sep = "_")

ge_fullpred <- cbind(ge_adddecyear, predict_m, predict_f)

#ge_predm <- cbind(ge_year, predict_m)
#ge_predf <- cbind(ge_year, predict_f)

# plot
ge_plot <- ggplot(ge_fullpred, aes(x = year, y = total_females)) +
  geom_ribbon(aes(ymin = fit.lwr_f, ymax = fit.upr_f), fill = "tomato3", alpha = 0.35) +
  geom_ribbon(aes(ymin = fit.lwr_m, ymax = fit.upr_m), fill = "steelblue3", alpha = 0.35) +
  geom_point(color = "tomato2") +
  geom_point(aes(x = year, y = total_males), color = "steelblue3") + 
  geom_line(aes(x = year, y = fit.fit_f), color = "tomato2") +
  geom_line(aes(x = year, y = fit.fit_m), color = "steelblue3") +
  scale_x_continuous(limits = c(1965, 2015), expand=c(0,0)) +
  scale_y_continuous(limits = c(-100000, 2100000), expand=c(0,0)) +
  labs(y = "Total enrollment", x = "Year") +
  theme(legend.position = "top") +
  theme_classic()

ge_plot
```


Problem 2 (Rachel):
```{r}

pf_fem <- pf %>% 
  filter(field == "physical_science" | field == "engineering" | field == "education" | field == "humanities", sex == "F") %>%
  select(field, year, number) %>%
  spread(year, number) %>%
  select(-field)

#p-value < 0.05, there is a significant effect of year on number of female students in each field 

rownames(pf_fem) <- c("physical_science", "engineering", "education", "humanities")

pf_chisqfem <- chisq.test(pf_fem)
pf_chisqfem
 
phd_shifts <- pf_fem %>% 
  ggplot(aes(x = year, y = number)) +
  geom_col(aes(fill = field), position = "dodge") +
  scale_x_continuous(expand=c(0,0), breaks = seq(1985,2015, by=15)) +
  scale_y_continuous(expand=c(0,0)) +
  theme_classic() +
  labs(
    x = "Year",
    y = "Female PhDs Awarded"
  )
phd_shifts

#chi-square (need to work on)
#phd_chi <- chisq.test(pf_fem) 
#phd_chi
```
Problem 2 (Michael):
```{r}
pf_f <- pf %>% 
  filter(field == "physical_science" | field == "engineering" | field == "education" | field == "humanities", sex == "F") %>%
  select(field, year, number) %>%
  spread(year, number) %>%
  select(-field)

rownames(pf_f) <- c("physical_science", "engineering", "education", "humanities")

pf_chisqf <- chisq.test(pf_f)
pf_chisqf

pf_fplt <- pf %>% 
  filter(field == "physical_science" | field == "engineering" | field == "education" | field == "humanities", sex == "F") %>%
  select(field, year, number)
pf_fplt$year <- as.character(pf_fplt$year)

pf_plt <- ggplot(pf_fplt, aes(x = field, y = number)) +
  geom_col(aes(fill = year), position = "dodge") +
  theme_classic() +
  theme(legend.position = "top") +
  labs(
    x = "Field",
    y = "PhDs awarded to females"
  ) +
  scale_y_continuous(expand=c(0,0))
pf_plt
```


Problem 3 (Rachel):
```{r}

#absolute difference in medians
#Employed Male/Female
emp_m_median <- median(ms$employment_male) #75167
emp_f_median <- median(ms$employment_female) #71750
emp_m_median - emp_f_median #3417
#Postdoc Male/Female
post_m_median <- median(ms$postdoc_male) #4800
post_f_median <- median(ms$postdoc_female) #4500
post_m_median - post_f_median # 3000

hist_emp_m = ggplot(ms, aes(ms$employment_male)) + geom_histogram()
qq_emp_m = ggplot(ms, aes(sample = ms$employment_male)) + geom_qq()

hist_emp_f = ggplot(ms, aes(ms$employment_female)) + geom_histogram()
qq_emp_f = ggplot(ms, aes(sample = ms$employment_female)) + geom_qq()

hist_post_m = ggplot(ms, aes(ms$postdoc_male)) + geom_histogram()
qq_post_m = ggplot(ms, aes(sample = ms$postdoc_male)) + geom_qq()

hist_post_f = ggplot(ms, aes(ms$postdoc_female)) + geom_histogram()
qq_post_f = ggplot(ms, aes(sample = ms$postdoc_female)) + geom_qq()

ftest_emp = var.test(ms$employment_male,ms$employment_female) # p=.88 thus variances are equal
ftest_post = var.test(ms$postdoc_male,ms$postdoc_female) # p=.85 thus variances are equal

#Mann-Whitney U
mwu_emp = wilcox.test(ms$employment_male,ms$employment_female)
mwu_emp # p = 0.3289 (not significant, ranks are equal)

mwu_post = wilcox.test(ms$postdoc_male,ms$postdoc_female)
mwu_post # p = 0.8671 (not significant, ranks are equal)

effsize_emp = cohen.d(ms$employment_male,ms$employment_female) # d estimate = 0.26 (small)
effsize_post = cohen.d(ms$postdoc_male,ms$postdoc_female) # d estimate = 0.04 (negligible)

#even though absolute difference is not significant, males are still paid a higher salary than females
```
Problem 3 (Jeremy):
```{r}

hist_emp_m = ggplot(ms, aes(ms$employment_male)) + geom_histogram()
hist_emp_f = ggplot(ms, aes(ms$employment_female)) + geom_histogram()
hist_post_m = ggplot(ms, aes(ms$postdoc_male)) + geom_histogram()
hist_post_f = ggplot(ms, aes(ms$postdoc_female)) + geom_histogram()

ftest_emp = var.test(ms$employment_male,ms$employment_female) # p=.88 thus variances are equal
ftest_post = var.test(ms$postdoc_male,ms$postdoc_female) # p=.85 thus variances are equal

ttest_emp = t.test(ms$employment_male,ms$employment_female, var.equal = T)
ttest_emp

ttest_post = t.test(ms$postdoc_male,ms$postdoc_female, var.equal = T)
ttest_post
```


Problem 4 (Rachel):
```{r}
# correlation of years since phd and years faculty service
yrs_corr <- fs %>% 
  ggplot(aes(x = years_since_PhD, y = years_faculty_service)) +
  geom_point(aes(color = sex), alpha = 0.5)
yrs_corr
#correlation years faculty service vs salary
service_corr <- fs %>% 
  ggplot(aes(x = years_faculty_service, y = salary)) +
  geom_point(aes(color = sex), alpha = 0.5)
service_corr

#filter by discipline -- should we run models for each discipline?
theoretical <- fs %>% 
  filter(discipline == "A")

applied <- fs %>% 
  filter(discipline == "B")

# Rank: reference level = profesor
fs$faculty_rank <- factor(fs$faculty_rank)
fs$faculty_rank <- fct_relevel(fs$faculty_rank, "Prof")
# everything model 
salary_lm1 <- lm(salary ~ faculty_rank + years_since_PhD + years_faculty_service + sex + discipline, data = fs)
plot(salary_lm1)
vif(salary_lm1)
# years since PhD = 7.5
# years faculty service = 5.9
# others less than 4
# years since phd and years faculty service is a bit redundant so maybe we don't need both?
salary_lm2 <- lm(salary ~ faculty_rank + years_faculty_service + sex + discipline, data = fs)
plot(salary_lm2)
vif(salary_lm2)
#faculty rank, discipline, sex, years_since_PhD
salary_lm3 <- lm(salary ~ faculty_rank + discipline + sex + years_since_PhD, data = fs)
plot(salary_lm3)
vif(salary_lm3)
#sex, rank discipline
salary_lm4 <- lm(salary ~ faculty_rank + discipline + sex, data = fs)
plot(salary_lm4)
vif(salary_lm4)
#rank, discipline, years_since_PhD
salary_lm5 <- lm(salary ~ faculty_rank + discipline + years_since_PhD, data = fs)
plot(salary_lm5)
vif(salary_lm5)

#AIC on all models
AIC(salary_lm1) #9094
AIC(salary_lm2) #9097
#lm1 has a lower AIC, but need to use judgmement do decide (look more into papers, think about whether service and years since phd are both needed)
AIC(salary_lm3) #9097
AIC(salary_lm4) #9095
AIC(salary_lm5) #9096
```

Problem 4 (Michael):
```{r}

fs_numonly <- fs %>%
  select(years_since_PhD, years_faculty_service, salary)
cor(fs_numonly)

# relevel faculty_rank to assistant prof
fs$faculty_rank <- factor(fs$faculty_rank)
fs$faculty_rank <- fct_relevel(fs$faculty_rank, "AsstProf")


# models
predsalary1 <- lm(salary ~ faculty_rank + discipline + years_since_PhD + years_faculty_service + sex, data = fs)
plot(predsalary1, which=c(2,1))

# the residuals do not look homoskedastic to me. this will effect predictive capacity, but not necessarily coefficients. 

fs_a <- fs %>%
  filter(discipline == "A") 
fs_b <- fs %>%
  filter(discipline == "B")

predsalary_a <- lm(salary ~ faculty_rank + years_since_PhD + years_faculty_service + sex, data = fs_a) # only theoretical
plot(predsalary_a, which=c(2,1))

predsalary_b <- lm(salary ~ faculty_rank + years_since_PhD + years_faculty_service + sex, data = fs_b) # only applied
plot(predsalary_b, which=c(2,1))

# heteroskedasticity seems to come mostly from applied faculty. Have two different models? 

```

Problem 4 (Jeremy):
```{r}

```








